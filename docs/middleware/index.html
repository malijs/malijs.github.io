<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">Middleware | Mali</title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.5em -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:400;word-wrap:break-word;}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2rem;line-height:2.25rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:2.25rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:2.25rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.5rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.5rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.5rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}ul{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.5rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.5rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;font-size:1rem;line-height:1.5rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}blockquote{margin-left:1.5rem;margin-right:1.5rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.5rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.5rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.5rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}li > ul{margin-left:1.5rem;margin-bottom:calc(1.5rem / 2);margin-top:calc(1.5rem / 2);}code{font-size:0.85rem;line-height:1.5rem;}kbd{font-size:0.85rem;line-height:1.5rem;}samp{font-size:0.85rem;line-height:1.5rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;padding-left:1rem;padding-right:1rem;padding-top:0.75rem;padding-bottom:calc(0.75rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}</style><style>.demo1-ball{border-radius:99px;background-color:#fff;width:50px;height:50px;border:3px solid #fff;position:absolute;background-size:50px}.warn{position:relative;padding:15px;font-size:14px;line-height:1.5;color:#4c4a42;background-color:#fff9ea;border:1px solid #dfd8c2;border-radius:3px;p:last-child{margin-bottom:0}}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media only screen and (min-width:700px){.breakpoint-min-width-700{display:block}.breakpoint-max-width-700{display:none}}@media only screen and (max-width:700px){.breakpoint-min-width-700{display:none}.breakpoint-max-width-700{display:block}}</style><style>
                  a {
                    color: rgb(60,188,188);
                  }
                  .ball-0 {
                    background-image: url(/docs/some-react-code/0.jpg);
                  }
                  .ball-1 {
                    background-image: url(/docs/some-react-code/1.jpg);
                  }
                  .ball-2 {
                    background-image: url(/docs/some-react-code/2.jpg);
                  }
                  .ball-3 {
                    background-image: url(/docs/some-react-code/3.jpg);
                  }
                  .ball-4 {
                    background-image: url(/docs/some-react-code/4.jpg);
                  }
                  .ball-5 {
                    background-image: url(/docs/some-react-code/5.jpg);
                  }
                </style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="722315714"><div style="background:#ffffff;color:rgb(18,57,57);" data-reactid="2"><div style="max-width:960px;margin-left:auto;margin-right:auto;padding-left:1.125rem;padding-top:10px;padding-bottom:10px;display:flex;border-bottom-width:2px;border-bottom-color:#3CBCBC;border-bottom-style:solid;" data-reactid="3"><div style="display:flex;align-items:center;" data-reactid="4"><a style="text-decoration:none;color:rgb(18,57,57);" href="/" data-reactid="5"><div style="display:flex;align-items:center;vertical-align:baseline;" data-reactid="6"><div style="width:70px;vertical-align:middle;padding-left:0.75rem;padding-right:0.75rem;" data-reactid="7"><img src="/mali-logo.png" style="vertical-align:middle;margin-bottom:0px;" data-reactid="8"/></div><div style="font-size:2.25rem;font-weight:bold;vertical-align:middle;padding-left:0.75rem;padding-right:0.75rem;" data-reactid="9">MALI</div></div></a></div><div style="width:100%;display:flex;vertical-align:center;justify-content:flex-end;" data-reactid="10"><a style="background:#ffffff;color:#3CBCBC;float:right;text-decoration:none;padding-left:0.75rem;padding-right:0.75rem;padding-bottom:1.125rem;padding-top:1.125rem;" href="/docs/" data-reactid="11">Documentation</a><a style="background:#ffffff;color:rgb(18,57,57);float:right;text-decoration:none;padding-left:0.75rem;padding-right:0.75rem;padding-bottom:1.125rem;padding-top:1.125rem;" href="/examples/" data-reactid="12">Examples</a><a style="float:right;color:rgb(18,57,57);text-decoration:none;padding-left:0.75rem;padding-right:0.75rem;padding-bottom:1.125rem;padding-top:1.125rem;" href="https://github.com/malijs/mali" data-reactid="13">Github</a></div><span style="display:block;clear:both;" data-reactid="14"> </span></div></div><div style="max-width:960px;margin-left:auto;margin-right:auto;padding:1.5rem 1.125rem;padding-top:1.5rem;" data-reactid="15"><div data-reactid="16"><div class="breakpoint-min-width-700" data-reactid="17"><div style="overflow-y:auto;padding-right:calc(0.75rem - 1px);position:absolute;width:calc(12rem - 1px);border-right:1px solid lightgrey;" data-reactid="18"><ul style="list-style:none;margin-left:0;" data-reactid="19"><li style="margin-bottom:0.75rem;" data-reactid="20"><a style="text-decoration:none;" href="/docs/" data-reactid="21">Getting Started</a></li><li style="margin-bottom:0.75rem;" data-reactid="22"><a style="text-decoration:none;" href="/docs/application/" data-reactid="23">Application</a></li><li style="margin-bottom:0.75rem;" data-reactid="24"><a style="text-decoration:none;" href="/docs/context/" data-reactid="25">Context</a></li><li style="margin-bottom:0.75rem;" data-reactid="26"><a style="text-decoration:none;" href="/docs/handling-requests/" data-reactid="27">Handling requests</a></li><li style="margin-bottom:0.75rem;" data-reactid="28"><a style="text-decoration:none;" href="/docs/middleware/" data-reactid="29"><strong data-reactid="30">Middleware</strong></a></li><li style="margin-bottom:0.75rem;" data-reactid="31"><a style="text-decoration:none;" href="/docs/error-handling/" data-reactid="32">Error Handling</a></li><li style="margin-bottom:0.75rem;" data-reactid="33"><a style="text-decoration:none;" href="/docs/api-reference/" data-reactid="34">API Reference</a></li><li style="margin-bottom:0.75rem;" data-reactid="35"><a style="text-decoration:none;" href="/docs/links/" data-reactid="36">Links</a></li></ul></div><div style="padding:0 1.5rem;padding-left:calc(12rem + 1.5rem);" data-reactid="37"><div class="markdown" data-reactid="38"><!-- react-empty: 39 --><h1 data-reactid="40">Middleware</h1><div data-reactid="41"><h3>Overview</h3>
<p>Creating and using Mali middleware is accomplished in the same mechanisms
as <a href="http://koajs.com/">Koa</a> middleware, just taking into account the changes to
the application context. Mali middleware allows for flow both “downstream”,
and then control flows back “upstream”. All middleware functions have a signature
<code>(ctx, next)</code>, where the middleware should call <code>next</code> appropriately.</p>
<p>Simple example of a logging middleware:</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayHello</span> (<span class="hljs-params">ctx</span>) </span>{
  ctx.res = { <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello '</span>.concat(ctx.req.name) }
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-keyword">const</span> ms = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() - start
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'%s [%s] - %s ms'</span>, ctx.name, ctx.type, ms);
}

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Mali(PROTO_PATH, <span class="hljs-string">'Greeter'</span>)
app.use({ sayHello })
<span class="hljs-keyword">const</span> server1 = app.start(<span class="hljs-string">'0.0.0.0:50051'</span>)
</code></pre>
<p>A call to the <code>sayHello</code> remote function will result in the following log output:</p>
<pre><code class="language-sh">SayHello [unary] - 1 ms
</code></pre>
<h3>Middleware Best Practices</h3>
<p>This section covers middleware authoring best practices, such as middleware
accepting options, named middleware for debugging, among others.</p>
<h4>Middleware options</h4>
<p>When creating public middleware it’s useful to conform to the convention of
wrapping the middleware in a function that accepts options, allowing users to
extend functionality. Even if your middleware accepts <em>no</em> options, this is still
a good idea to keep things uniform.</p>
<p>Here our contrived <code>logger</code> middleware accepts a <code>format</code> string for customization,
and returns the middleware itself:</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">format</span>) </span>{
  format = format || <span class="hljs-string">':name [:type]'</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ctx, next</span>) </span>{
    <span class="hljs-keyword">const</span> str = format
      .replace(<span class="hljs-string">':name'</span>, ctx.name)
      .replace(<span class="hljs-string">':type'</span>, ctx.type)

    <span class="hljs-built_in">console</span>.log(str)

    <span class="hljs-keyword">await</span> next()
  }
}

app.use(logger())
app.use(logger(<span class="hljs-string">':name | :type'</span>))
</code></pre>
<h4>Named middleware</h4>
<p>Naming middleware is optional, however it’s useful for debugging purposes to assign a name.</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">format</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">ctx, next</span>) </span>{

  }
}
</code></pre>
<h4>Response Middleware</h4>
<p>Middleware that decide to respond to a request and wish to bypass downstream middleware may
simply omit <code>next()</code>. Typically this will be in routing middleware, but this can be performed by
any. For example the following will respond with “two”, however all three are executed, giving the
downstream “three” middleware a chance to manipulate the response.</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn1</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; one'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; one'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn2</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; two'</span>)
  ctx.res = { <span class="hljs-attr">message</span>: <span class="hljs-string">'two'</span> }
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; two'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn3</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; three'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; three'</span>)
}

app.use(<span class="hljs-string">'sayHello'</span>, fn1, fn2, fn3)
</code></pre>
<p>The following configuration omits <code>next()</code> in the second middleware, and will still respond
with “two”, however the third (and any other downstream middleware) will be ignored:</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn1</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; one'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; one'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn2</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; two'</span>)
  ctx.res = { <span class="hljs-attr">message</span>: <span class="hljs-string">'two'</span> }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; two'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn3</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; three'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; three'</span>)
}

app.use(<span class="hljs-string">'sayHello'</span>, fn1, fn2, fn3)
</code></pre>
<p>When the furthest downstream middleware executes <code>next()</code>, it’s really yielding to a noop
function, allowing the middleware to compose correctly anywhere in the stack.</p>
<h3>Async operations</h3>
<p>Async function and promise forms Mali’s foundation, allowing you to write non-blocking sequential code.
For example this middleware reads the filenames from <code>./docs</code>, and then reads the contents
of each file in parallel before assigning the response to the joint result.</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-promise'</span>);

app.use(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-keyword">const</span> paths = <span class="hljs-keyword">await</span> fs.readdir(<span class="hljs-string">'docs'</span>)
  <span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(paths.map(<span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> fs.readFile(<span class="hljs-string">`docs/<span class="hljs-subst">${path}</span>`</span>, <span class="hljs-string">'utf8'</span>)))
  ctx.res = { <span class="hljs-attr">content</span>: files.join(<span class="hljs-string">''</span>) }
})
</code></pre>
<h3>Common Middleware</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/malijs/apikey">apikey</a></td>
<td>Api key authorization metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/bearer">bearer</a></td>
<td>Bearer token authorization metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/logger">logger</a></td>
<td>Development logging middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/metadata">metadata</a></td>
<td>Metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/metadata-auth">metadata auth</a></td>
<td>Authorization metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/param">param</a></td>
<td>Request param middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/requestid">request ID</a></td>
<td>Request ID metadata middleware. Sources request ID into context.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/tojson">toJSON</a></td>
<td>Automatically calls <code>toJSON</code> on response if the method is present in response object.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/toobject">toObject</a></td>
<td>Automatically calls <code>toObject</code> on response if the method is present in response object.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/transform">transform</a></td>
<td>Transform response payload middleware.</td>
</tr>
</tbody>
</table>
</div></div></div></div><div class="breakpoint-max-width-700" data-reactid="42"><strong data-reactid="43">Topics:</strong><!-- react-text: 44 --> <!-- /react-text --><select data-reactid="45"><option value="/docs/" data-reactid="46">Getting Started</option><option value="/docs/application/" data-reactid="47">Application</option><option value="/docs/context/" data-reactid="48">Context</option><option value="/docs/handling-requests/" data-reactid="49">Handling requests</option><option selected="" value="/docs/middleware/" data-reactid="50">Middleware</option><option value="/docs/error-handling/" data-reactid="51">Error Handling</option><option value="/docs/api-reference/" data-reactid="52">API Reference</option><option value="/docs/links/" data-reactid="53">Links</option></select><br data-reactid="54"/><br data-reactid="55"/><div class="markdown" data-reactid="56"><!-- react-empty: 57 --><h1 data-reactid="58">Middleware</h1><div data-reactid="59"><h3>Overview</h3>
<p>Creating and using Mali middleware is accomplished in the same mechanisms
as <a href="http://koajs.com/">Koa</a> middleware, just taking into account the changes to
the application context. Mali middleware allows for flow both “downstream”,
and then control flows back “upstream”. All middleware functions have a signature
<code>(ctx, next)</code>, where the middleware should call <code>next</code> appropriately.</p>
<p>Simple example of a logging middleware:</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sayHello</span> (<span class="hljs-params">ctx</span>) </span>{
  ctx.res = { <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello '</span>.concat(ctx.req.name) }
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-keyword">const</span> ms = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() - start
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'%s [%s] - %s ms'</span>, ctx.name, ctx.type, ms);
}

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Mali(PROTO_PATH, <span class="hljs-string">'Greeter'</span>)
app.use({ sayHello })
<span class="hljs-keyword">const</span> server1 = app.start(<span class="hljs-string">'0.0.0.0:50051'</span>)
</code></pre>
<p>A call to the <code>sayHello</code> remote function will result in the following log output:</p>
<pre><code class="language-sh">SayHello [unary] - 1 ms
</code></pre>
<h3>Middleware Best Practices</h3>
<p>This section covers middleware authoring best practices, such as middleware
accepting options, named middleware for debugging, among others.</p>
<h4>Middleware options</h4>
<p>When creating public middleware it’s useful to conform to the convention of
wrapping the middleware in a function that accepts options, allowing users to
extend functionality. Even if your middleware accepts <em>no</em> options, this is still
a good idea to keep things uniform.</p>
<p>Here our contrived <code>logger</code> middleware accepts a <code>format</code> string for customization,
and returns the middleware itself:</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">format</span>) </span>{
  format = format || <span class="hljs-string">':name [:type]'</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ctx, next</span>) </span>{
    <span class="hljs-keyword">const</span> str = format
      .replace(<span class="hljs-string">':name'</span>, ctx.name)
      .replace(<span class="hljs-string">':type'</span>, ctx.type)

    <span class="hljs-built_in">console</span>.log(str)

    <span class="hljs-keyword">await</span> next()
  }
}

app.use(logger())
app.use(logger(<span class="hljs-string">':name | :type'</span>))
</code></pre>
<h4>Named middleware</h4>
<p>Naming middleware is optional, however it’s useful for debugging purposes to assign a name.</p>
<pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">format</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">ctx, next</span>) </span>{

  }
}
</code></pre>
<h4>Response Middleware</h4>
<p>Middleware that decide to respond to a request and wish to bypass downstream middleware may
simply omit <code>next()</code>. Typically this will be in routing middleware, but this can be performed by
any. For example the following will respond with “two”, however all three are executed, giving the
downstream “three” middleware a chance to manipulate the response.</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn1</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; one'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; one'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn2</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; two'</span>)
  ctx.res = { <span class="hljs-attr">message</span>: <span class="hljs-string">'two'</span> }
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; two'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn3</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; three'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; three'</span>)
}

app.use(<span class="hljs-string">'sayHello'</span>, fn1, fn2, fn3)
</code></pre>
<p>The following configuration omits <code>next()</code> in the second middleware, and will still respond
with “two”, however the third (and any other downstream middleware) will be ignored:</p>
<pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn1</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; one'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; one'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn2</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; two'</span>)
  ctx.res = { <span class="hljs-attr">message</span>: <span class="hljs-string">'two'</span> }
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; two'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn3</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt;&gt; three'</span>)
  <span class="hljs-keyword">await</span> next()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&lt;&lt; three'</span>)
}

app.use(<span class="hljs-string">'sayHello'</span>, fn1, fn2, fn3)
</code></pre>
<p>When the furthest downstream middleware executes <code>next()</code>, it’s really yielding to a noop
function, allowing the middleware to compose correctly anywhere in the stack.</p>
<h3>Async operations</h3>
<p>Async function and promise forms Mali’s foundation, allowing you to write non-blocking sequential code.
For example this middleware reads the filenames from <code>./docs</code>, and then reads the contents
of each file in parallel before assigning the response to the joint result.</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-promise'</span>);

app.use(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-keyword">const</span> paths = <span class="hljs-keyword">await</span> fs.readdir(<span class="hljs-string">'docs'</span>)
  <span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(paths.map(<span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> fs.readFile(<span class="hljs-string">`docs/<span class="hljs-subst">${path}</span>`</span>, <span class="hljs-string">'utf8'</span>)))
  ctx.res = { <span class="hljs-attr">content</span>: files.join(<span class="hljs-string">''</span>) }
})
</code></pre>
<h3>Common Middleware</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/malijs/apikey">apikey</a></td>
<td>Api key authorization metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/bearer">bearer</a></td>
<td>Bearer token authorization metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/logger">logger</a></td>
<td>Development logging middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/metadata">metadata</a></td>
<td>Metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/metadata-auth">metadata auth</a></td>
<td>Authorization metadata middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/param">param</a></td>
<td>Request param middleware.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/requestid">request ID</a></td>
<td>Request ID metadata middleware. Sources request ID into context.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/tojson">toJSON</a></td>
<td>Automatically calls <code>toJSON</code> on response if the method is present in response object.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/toobject">toObject</a></td>
<td>Automatically calls <code>toObject</code> on response if the method is present in response object.</td>
</tr>
<tr>
<td><a href="https://github.com/malijs/transform">transform</a></td>
<td>Transform response payload middleware.</td>
</tr>
</tbody>
</table>
</div></div></div></div><span style="display:block;clear:both;" data-reactid="60"> </span></div></div></div><script src="/bundle.js?t=1483148825857"></script></body></html>